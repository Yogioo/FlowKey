# 窗口切换功能使用说明

## 功能概述

实现了基于旋钮的窗口切换功能，支持在当前虚拟桌面的窗口间循环切换。

## 核心特性

### ✅ 已实现功能

1. **虚拟桌面感知**
   - 自动过滤其他虚拟桌面的窗口
   - 只在当前虚拟桌面的窗口间切换
   - 使用 Windows IVirtualDesktopManager API

2. **智能窗口过滤**
   - 自动排除系统覆盖层窗口（Overlay）
   - 自动排除通知窗口（ToastWindow）
   - 可自定义过滤规则

3. **可靠的窗口切换**
   - 使用 Alt+Tab / Alt+Shift+Tab 模拟
   - 确保切换成功率高
   - 自动处理窗口激活限制

4. **配置 UI 支持**
   - 新增"🪟 窗口切换"动作类型
   - 支持在设置界面配置映射
   - 实时提示和帮助文本

## 使用方法

### 1. 默认映射

在"窗口管理"模式下，已预设以下映射：

- **f24（右旋）** → 下一个窗口
- **f23（左旋）** → 上一个窗口

### 2. 在配置UI中自定义

1. 打开设置面板（Ctrl+Alt+Shift+S）
2. 切换到"窗口管理"模式
3. 添加或编辑映射时：
   - 动作类型：选择"🪟 窗口切换"
   - 目标键：输入 `next` 或 `prev`
   - 源键：绑定你的旋钮或按键

### 3. 配置示例

```json
{
  "窗口管理": {
    "enabled": true,
    "mappings": [
      {
        "source": "f24",
        "target": "next",
        "block": true,
        "hint": "下一个窗口",
        "action_type": "window_cycle"
      },
      {
        "source": "f23",
        "target": "prev",
        "block": true,
        "hint": "上一个窗口",
        "action_type": "window_cycle"
      }
    ]
  }
}
```

## 技术实现

### 窗口枚举与过滤

```python
# 1. 枚举所有顶层窗口
EnumWindows()

# 2. 过滤条件
- IsWindowVisible() == True
- 有窗口标题
- 不在排除列表中
- 在当前虚拟桌面上

# 3. 切换方式
- Alt+Tab (下一个)
- Alt+Shift+Tab (上一个)
```

### 虚拟桌面检测

使用 Windows COM API：
- CLSID: `{AA509086-5CA9-4C25-8F95-589D3C07B48A}`
- IID: `{A5CD92FF-29BE-454C-8D04-D82879FB3F1B}`
- 方法: `IsWindowOnCurrentVirtualDesktop()`

## 自定义过滤规则

编辑 `key_mapper/utils/window_cycler.py` 的 `_should_include_window()` 方法：

```python
def _should_include_window(self, hwnd: int, title: str) -> bool:
    # 完全匹配排除
    exclude_titles = [
        "Program Manager",
        "Windows Input Experience",
    ]

    # 关键词排除
    exclude_keywords = [
        "Overlay",
        "ToastWindow",
    ]

    if title in exclude_titles:
        return False

    for keyword in exclude_keywords:
        if keyword in title:
            return False

    return True
```

## 依赖项

新增依赖：
- `comtypes` - Windows COM API 调用

安装：
```bash
pip install -r requirements.txt
```

## 已知问题与限制

### 1. 短暂显示任务切换器
- 使用 Alt+Tab 方式会短暂显示 Windows 任务切换器界面
- 这是为了确保高成功率的权衡方案

### 2. 特殊窗口
- 某些系统窗口或管理员权限窗口可能无法切换
- 全屏独占应用（游戏等）可能影响切换

### 3. 性能
- 每次切换会枚举所有窗口，有轻微延迟（约 50-100ms）
- 虚拟桌面检测增加约 10-20ms

## 测试

运行测试脚本验证功能：

```bash
# 测试窗口列表
python test_window_cycler.py

# 测试虚拟桌面过滤
python test_virtual_desktop.py
```

## 故障排除

### Q: 窗口切换没有反应？
A: 检查：
1. 是否在"窗口管理"模式
2. 映射是否正确配置
3. 查看控制台日志

### Q: 切换到了错误的窗口？
A: 可能原因：
1. 窗口过滤规则需要调整
2. 其他虚拟桌面的窗口干扰（已修复）

### Q: comtypes 导入失败？
A: 运行：
```bash
pip install comtypes
```

## 更新日志

### v1.0 (2025-12-06)
- ✅ 实现基础窗口切换功能
- ✅ 添加虚拟桌面过滤
- ✅ 集成到配置 UI
- ✅ 智能窗口过滤
- ✅ Alt+Tab 切换方式
